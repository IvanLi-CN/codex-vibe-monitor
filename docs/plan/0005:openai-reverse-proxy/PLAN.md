# OpenAI Reverse Proxy（`/v1/*` 透明透传）

## 背景

当前项目提供统计采集与可视化接口，但不提供 OpenAI 兼容反向代理入口。为便于客户端统一接入，需要在本服务增加 `/v1/*` 透传能力。

## 目标

- 为客户端提供 `/v1/*` 入口，转发到上游 OpenAI 兼容服务。
- 认证信息由客户端携带并原样透传，不在服务端重写。
- 支持流式响应与普通响应，尽量保持与直连上游一致的行为。

## 非目标

- 不改动现有统计轮询逻辑与数据库结构。
- 不做 token 注入、鉴权代理、请求改写。
- 不新增请求审计或代理日志落库。

## 范围

### In

- 新增 `OPENAI_UPSTREAM_BASE_URL` 配置。
- 新增 `ANY /v1/*path` 路由与代理处理逻辑。
- 透传请求头（过滤 hop-by-hop 头）、请求体、状态码、响应头与响应体。
- 支持 stream/chunked 响应透传。
- 更新 README 配置与接口说明。

### Out

- 前端页面改造。
- 限流、熔断、重试策略引入。
- 代理访问控制策略（如 IP 白名单）。

## 需求列表

### MUST

- `Authorization` 头必须原样透传到上游。
- 代理路径与 query 必须保持一致。
- 上游 4xx/5xx 必须原样返回（不包装）。
- 上游不可达时返回 `502 Bad Gateway`。
- 至少覆盖代理核心路径的自动化测试。

### SHOULD

- 过滤标准 hop-by-hop 头，避免协议级问题。
- 错误响应保持简洁可诊断。

### COULD

- 后续支持真正的请求上行流式透传（本次先请求体聚合后转发）。

## 验收标准

1. Given 客户端请求 `POST /v1/...` 且携带 `Authorization`，When 经过本服务，Then 上游收到相同认证头并成功鉴权。
2. Given 客户端请求 `GET /v1/models?limit=10`，When 代理转发，Then 上游收到相同 path/query。
3. Given 上游返回 429/401/500，When 客户端经代理访问，Then 客户端收到相同状态码与关键响应头。
4. Given 上游返回流式分块响应，When 客户端经代理访问，Then 客户端能持续接收分块数据（非整包等待）。
5. Given 访问现有 `/api/*` 与 `/events`，When 本改动完成后，Then 行为保持不变。

## 测试策略

- 单元测试：URL 组装、hop-by-hop 头过滤。
- 集成测试（本地临时上游服务）：验证认证头透传、query 透传、状态/响应头透传、流式响应透传、上游不可达返回 502。
- 回归验证：`cargo check`、`cargo test`。

## 风险与缓解

- 风险：不正确透传连接级头导致请求异常。
  - 缓解：集中封装过滤函数，并加测试覆盖。
- 风险：上游不可用时错误语义不清。
  - 缓解：统一 `502` 并返回结构化错误信息。

## 里程碑

- [x] M1 配置与路由接入（`OPENAI_UPSTREAM_BASE_URL` + `/v1/*`）
- [x] M2 代理请求/响应透传（含 header 过滤与流式响应）
- [x] M3 测试与文档更新（README + 自动化测试通过）
