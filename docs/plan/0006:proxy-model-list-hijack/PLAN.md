# Proxy 模型列表劫持与上游实时合并

## 背景

当前服务已支持 `/v1/*` 反向代理，但对 `GET /v1/models` 仅透传上游。当上游不提供标准模型列表或临时不可用时，客户端难以获得稳定的模型发现结果。

## 目标

- 为 `GET /v1/models` 提供可配置的“劫持返回预置列表”能力。
- 支持可选“实时合并上游模型列表”能力。
- 提供前端设置入口，允许全局开关与持久化。

## 非目标

- 不改动除 `GET /v1/models` 之外的代理行为。
- 不提供前端自定义编辑预置模型列表。
- 不引入限流、重试、熔断等额外代理治理能力。

## 范围

### In

- 后端新增设置读写接口（全局持久化到 SQLite）：
  - `GET /api/settings/proxy-models`
  - `PUT /api/settings/proxy-models`
- `GET /v1/models` 新增劫持分支逻辑：
  - 关闭劫持：继续透传上游。
  - 开启劫持 + 关闭合并：仅返回预置列表。
  - 开启劫持 + 开启合并：实时请求上游并与预置去重合并。
  - 合并模式下上游失败：降级为仅返回预置列表。
- 前端新增设置界面与开关。
- 中英文文案补齐。
- 自动化测试覆盖核心分支。

### Out

- `/v1/models` 之外的请求改写。
- 模型列表缓存策略。
- 多租户/按用户维度配置。

## 预置模型列表

- `gpt-5.3-codex`
- `gpt-5.2-codex`
- `gpt-5.1-codex-max`
- `gpt-5.1-codex-mini`
- `gpt-5.2`

## 需求列表

### MUST

- 默认 `hijackEnabled=false`，`mergeUpstreamEnabled=false`。
- 设置变更对代理行为实时生效。
- 设置持久化后重启可恢复。
- 合并时按 `model.id` 去重，预置优先。
- 合并上游失败时返回 200 + 预置列表（可附诊断响应头）。

### SHOULD

- 前端在开关保存失败时做 UI 回滚并提示错误。
- 前端在 `hijackEnabled=false` 时禁用“合并上游”开关。

### COULD

- 在响应头暴露“上游合并成功/失败”诊断信息。

## 验收标准

1. Given 默认配置，When 请求 `GET /v1/models`，Then 行为与当前透传一致。
2. Given 开启劫持且关闭合并，When 请求 `GET /v1/models`，Then 返回仅含预置模型列表。
3. Given 开启劫持与合并，When 上游返回模型列表，Then 返回预置+上游去重合并结果。
4. Given 开启劫持与合并，When 上游失败或超时，Then 返回预置模型列表且请求成功。
5. Given 用户在前端切换开关，When 保存成功，Then 后端设置与代理行为实时更新。

## 测试策略

- Rust：
  - 设置 API 读写与持久化测试。
  - `/v1/models` 三种行为分支测试。
  - 合并失败降级测试。
- Web：
  - 设置入口展示与交互测试（e2e）。
  - 开关保存失败回滚验证（可通过 mock 或测试环境 API 失败注入）。

## 风险与缓解

- 风险：上游返回结构不标准导致合并解析失败。
  - 缓解：解析失败按“上游失败”路径降级，仅返回预置列表。
- 风险：新增状态读写引入并发一致性问题。
  - 缓解：设置更新采用“DB 成功后更新内存状态”的单向提交流程。

## 里程碑

- [x] M1 数据模型与后端设置 API（含持久化）
- [x] M2 `/v1/models` 劫持与实时合并逻辑
- [x] M3 前端设置界面与自动化验证
